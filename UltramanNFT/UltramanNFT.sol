// SPDX-License-Identifier: MIT
pragma solidity 0.6.8;

/**
* ................................................................................................................................
* ................................................................................................................................
* ....................................................unftunftunftunftunftunft....................................................
* ............................................unftunftunftunftunftunftunftunftunftunft............................................
* .......................................unftunftunftunftunftunft..unft......unftunftunftun.......................................
* ...................................ftunftunftunftunftunftunftu...nftu..............nftunftunf...................................
* ...............................tunftunftunftunftunftunftunftun...ftunf..................tunftunft...............................
* ............................unftunftunftunftunftunftunftunftu....nftun......................ftunftun............................
* ..........................ftunftunftunftunftunftunftunftunftu....nftunf........................tunftunf.........................
* .......................tunftunftunftunftunftunftunftunftunf......tunftunf.........................tunftun.......................
* .....................ftunftunftunftunftunftunftunftunft..........unftunftunft........................unftun.....................
* ...................ftunftunftunftunftunftunftunftun..............ftunftunftunftun......................ftunft...................
* .................unftunftunftunftunftunftunftunft..........unf...tunftunftunftunftu......................nftunf.................
* ................tunftunftunftunftunftunftunftu............nftu...nftunftunftunftunftun.....................ftunft...............
* ..............unftunftunftunftunftunftunftun..............ftun...ftunftunftunftunftunftu.....................nftun..............
.............ftunftunftunftunftunftunftunf................tunf...tunftunftunftunftunftunft....................unftun............
...........ftunftunftunftunftunftunftunft..................unf...tunftunftunftunftunftunftu.....................nftun...........
..........ftunftunftunftunftunftunftunf....................tun...ftunftunftunftunftunftunftu.....................nftun..........
.........ftunftunftunftunftunftunftunf.....................tun...ftunftunftunftunftunftunftunf....................tunft.........
........unftunftunftunftunftunftunftu......................nft...unftunftunftunftunftunftunftu.....................nftun........
.......ftunftunftunftunftunftunftunft......................unf...tunftunftunftunftunftunftunftu......................nftu.......
......nftunftunftunftunftunftunftunf.......................tun...ftunftunftunftunftunftunftunft......................unftu......
......nftunftunftunftunftunftunft..........................unf...tunftunftunftunftunftunftunftunftu...................nftun.....
.....ftunftunftunftunftunftun...............................ft...unftunftunftunftunftunftunftunftunftun................ftunf....
....tunftunftunftunftunftunft...............................un...ftunftunftunftunftunftunftunftunftunft.................unft....
....unftunftunftunftunftunftu.......nftunftunftu............nf...tunftunftunftunf............tunftunftu.................nftun...
...ftunftunftunftunftunftunft......unftunftunftunftu........nf...tunftunftunft................unftunftu..................nftu...
...nftunftunftunftunftunftunf......tunftunftunftunftun......ft...unftunftunf..................tunftunft..................unftu..
...nftunftunftunftunftunftunf......tunftunftunftunftunft....un...ftunftunf....................tunftunft..................unftu..
..nftunftunftunftunftunftunft.......unftunftunftunftunftu...nf...tunftunf....................tunftunftu...................nftu..
..nftunftunftunftunftunftunft........unftunftunftunftunftu..nf...tunftun....................ftunftunftu...................nftu..
..nftunftunftunftunftunftunft..........unftunftunftunftunf..tu...nftunf...................tunftunftunft...................unft..
..unftunftunftunftunftunftunf............tunftunftunftunft...u...nftunf.................tunftunftunftun...................ftun..
..ftunftunftunftunftunftunftu...............nftunftunftun....f...tunftun.............ftunftunftunftunft...................unft..
..unftunftunftunftunftunftunf.....................tunf.......t...unftunftunftunftunftunftunftunftunftun...................ftun..
..ftunftunftunftunftunftunftu................................n...ftunftunftunftunftunftunftunftunftunft...................unft..
...unftunftunftunftunftunftun................................f...tunftunftunftunftunftunftunftunftunftu...................nftu..
...nftunftunftunftunftunftunft...................................unftunftunftunftunftunftunftunftunftu...................nftun..
...ftunftunftunftunftunftunftunf.................................tunftunftunftunftunftunftunftunftun.....................ftun...
...ftunftunftunftunftunftunftunftu...............................nftunftunftunftunftunftunftunftun......................ftunf...
....tunftunftunftunftunftunftunftunf.............................tunftunftunftunftunftunftunftun........................ftun....
.....ftunftunftunftunftunftunftunftunf...........................tunftunftunftunftunftunftunft.........................unftu....
.....nftunftunftunftunftunftunftunftun...........................ftunftunftunftunftunftunftunf.........................tunf.....
......tunftunftunftunftunftunftunftunft.........unftunftunftunftunftunftunftunftunftunftunftu.........................nftu......
.......nftunftunftunftunftunftunftunftu..........nftunftunftunftunftunftunftunftunftunftunft.........................unftu......
........nftunftunftunftunftunftunftunftu.........nftu.................nftunftunftunftunftunf........................tunft.......
.........unftunftunftunftunftunftunftunft........unftu..nftunftunftunftunftunftunftunftunft........................unftu........
..........nftunftunftunftunftunftunftunftu........nft....unftunftunftunftunftunftunftunftu........................nftun.........
...........ftunftunftunftunftunftunftunftun.................ftunftunftunftunftunftunftunf........................tunft..........
............unftunftunftunftunftunftunftunft.................unftunftunftunftunftunftun........................ftunf............
.............tunftunftunftunftunftunftunftunft...............unftunftunftunftunftunftu........................nftun.............
...............ftunftunftunftunftunftunftunftun......................ftunftunftunftu........................nftunf..............
................tunftunftunftunftunftunftunftunftu.............nftunftunftunftunftun......................ftunft................
..................unftunftunftunftunftunftunftunftun..........ftunftunftunftunftunft....................unftun..................
....................ftunftunftunftunftunftunf...tunftu......nftunftunftunftunftunftu..................nftunf....................
......................tunftunftunftunftunftun.......ftunftunftunftunftunftunftunftun...............ftunftu......................
.........................nftunftunftunftunftu............nftunftunftunftunftunftunftu............nftunft........................
...........................unftunftunftunftunftun............ftunftunftunftunftunftunf.......tunftunf...........................
..............................tunftunftunftunftunftun...........ftunftunftunftunftunftun..ftunftun..............................
.................................ftunftunftunftunftunftun.......ftunftunftunftunftunftunftunftu.................................
.....................................nftunftunftunftunftunftun..ftunftunftunftunftunftunftu.....................................
..........................................nftunftunftunftunftunftunftunftunftunftunftun.........................................
................................................ftunftunftunftunftunftunftunftunf...............................................
...........................................................tunftunftu...........................................................
................................................................................................................................
................................................................................................................................
................................................................................................................................
................................................................................................................................
..nftunftunft.......unftunftun.......ftunftunft.........unftunftun......ftunftunftunftunftunftun...ftunftunftunftunftunftunftun.
.....ftunft...........unftun...........ftunftunf...........tunft..........unftunf.........tunftu...nftunft....unftun.....ftunft.
.....unftu.............nftun............ftunftunft.........unftu...........nftunf..........tunft...unftu......nftunf......tunft.
.....unftu.............nftun............ftunftunftu........nftun...........ftunft..................unftu......nftunf.......tunf.
.....tunft.............unftu............nftu.nftunft.......unftu...........nftunf.............................tunftu............
.....nftun.............ftunf............tunf..tunftun......ftunf...........tunftu.......nftu..................nftunf............
.....tunft.............unftu............nftu...nftunft.....unftu...........nftunf......tunft..................unftun............
.....ftunf.............tunft............unft.....unftun....ftunf...........tunftunftunftunft..................unftun............
.....ftunf.............tunft............unft......unftunf..tunft...........unftunftunftunftu..................nftunf............
.....tunft.............unftu............nftu.......nftunft.unftu...........nftunf......tunft..................unftun............
.....ftunf.............tunft............unft........unftunftunft...........unftun.............................ftunft............
.....unftu.............nftun............ftun..........ftunftunft...........unftun.............................ftunft............
.....unftu.............nftun............ftun...........ftunftunf...........tunftu.............................nftunf............
.....tunftu...........nftun.............ftun............ftunftun...........ftunft.............................unftun............
......ftunftu.......nftunf..............tunft............unftunf..........tunftunf............................tunftun...........
........ftunftunftunftun.............ftunftunft...........unftun........ftunftunftun.......................ftunftunftun.........
............ftunftun............................................................................................................
................................................................................................................................
................................................................................................................................
* 
* 私たちは大きな移住の時代にいます. ますます多くの資産、特にトップIPと収集品が、ブロックチェーンNFTに移行し始めています. 
* これはデジタル時代の必然的な傾向です. これは、コレクターが必要とするまったく新しい世界です.
* 重くて些細で変更が難しいオフラインIDから自分自身を分離するまったく新しいプラットフォームです. 
* コレクターが本当に注目しているのは、NFTの歴史的地位、希少性、本質的価値、IPの影響、資産効果、革新などの特性です.
* これらの特性がこれらのNFTプロジェクトを人々の視野に入れているので、ウルトラマンクリプトはそうです. 人気があります.
* クリプトアートの分野で毎日新しい伝説が生まれ、ウルトラマンクリプトは最近最も眩しい伝説です.
*/
import "Context.sol";
import "IERC721.sol";
import "IERC721Receiver.sol";
import "ERC165.sol";
import "SafeMath.sol";
import "Address.sol";
import "EnumerableSet.sol";
import "EnumerableMap.sol";
import "Strings.sol";
import "ECDSA.sol";

/**
 * @title 非代替トークン標準の基本的な実装
 * @dev 見る https://eips.ethereum.org/EIPS/eip-721
 */
contract UltramanNFT is Context, ERC165, IERC721 {
    using SafeMath for uint256;
    using Address for address;
    using EnumerableSet for EnumerableSet.UintSet;
    using EnumerableMap for EnumerableMap.UintToAddressMap;
    using Strings for uint256;

    bytes4 private constant _ERC721_RECEIVED = 0x150b7a02;

    mapping (address => EnumerableSet.UintSet) private _holderTokens;

    EnumerableMap.UintToAddressMap private _tokenOwners;

    mapping (uint256 => address) private _tokenApprovals;
    mapping (address => mapping (address => bool)) private _operatorApprovals;

    string private _name;
    string private _symbol;
    string private _baseURI;
    bytes4 private constant _INTERFACE_ID_ERC721 = 0x80ac58cd;
    bytes4 private constant _INTERFACE_ID_ERC721_METADATA = 0x5b5e139f;
    bytes4 private constant _INTERFACE_ID_ERC721_ENUMERABLE = 0x780e9d63;

    bool private _paused = false;
    bool private _castingStop=false;
    address private _creator;
    mapping( address => bool) private _official;
   
    modifier whenNotPaused() {
        require(!paused(), "中断する");
        _;
    }

    modifier isOfficial() {
        require(_official[msg.sender]||_creator==msg.sender, "公式ではありません");
        _;
    }

   
    constructor () public {
        _name = "Ultraman NFT";
        _symbol = "UNFT";
        _official[msg.sender]=true;
        _creator = msg.sender;

        _registerInterface(_INTERFACE_ID_ERC721);
        _registerInterface(_INTERFACE_ID_ERC721_METADATA);
        _registerInterface(_INTERFACE_ID_ERC721_ENUMERABLE);
    }

    function isContract(address account) internal view returns (bool) {
        uint256 size;
        assembly { size := extcodesize(account) }
        return size > 0;
    }

   
    function paused() public view returns (bool) {
        return _paused;
    }

   
    function balanceOf(address owner) public override view returns (uint256) {
        require(owner != address(0), "ゼロアドレスの所有者クエリ");
        return _holderTokens[owner].length();
    }

    function ownerOf(uint256 tokenId) public view override returns (address) {
        return _tokenOwners.get(tokenId, "存在しないトークンの所有者クエリ");
    }

    function name() public view returns (string memory) {
        return _name;
    }

    function symbol() public view returns (string memory) {
        return _symbol;
    }

    function tokenURI(uint256 tokenId) public view returns (string memory) {
        require(_exists(tokenId), "存在しないトークンのURIクエリ");

        string memory base = baseURI();

        if (bytes(base).length == 0) {
            return tokenId.toString();
        }
        return string(abi.encodePacked(base,"/ipfs/",tokenId.toString()));
    }

    function baseURI() public view returns (string memory) {
        return _baseURI;
    }
   
    function setBaseURI(string memory baseURI_) public isOfficial returns(bool){
        _baseURI = baseURI_;
        return true;
    }

    function setSW(uint8 setType,bool val) public isOfficial returns(bool){
        if(setType == 1){
            _paused = val;
        }else if(setType == 2){
            _castingStop = val;
        }
        return true;
    }

    function setOfficial(address addr,bool operate) public returns(bool){
        require(_creator == msg.sender, "作成者ではありません");
        _official[addr] = operate;
        return true;
    }

    function tokenOfOwnerByIndex(address owner, uint256 index) public view returns (uint256) {
        return _holderTokens[owner].at(index);
    }

    function totalSupply() public view returns (uint256) {
        return _tokenOwners.length();
    }

    function tokenByIndex(uint256 index) public view returns (uint256) {
        (uint256 tokenId, ) = _tokenOwners.at(index);
        return tokenId;
    }

    function approve(address to, uint256 tokenId) public override whenNotPaused{
        address owner = UltramanNFT.ownerOf(tokenId);
        require(to != owner, "現在の所有者への承認");

        require(_msgSender() == owner || UltramanNFT.isApprovedForAll(owner, _msgSender()),
            "承認する発信者は所有者ではなく、すべての人に承認されている"
        );

        _approve(to, tokenId);
    }

    function getApproved(uint256 tokenId) public override view returns (address) {
        require(_exists(tokenId), "存在しないトークンの承認されたクエリ");

        return _tokenApprovals[tokenId];
    }

    function setApprovalForAll(address operator, bool approved) override public whenNotPaused{
        require(operator != _msgSender(), "発信者に承認する");

        _operatorApprovals[_msgSender()][operator] = approved;
        emit ApprovalForAll(_msgSender(), operator, approved);
    }

    function isApprovedForAll(address owner, address operator) public override view returns (bool) {
        return _operatorApprovals[owner][operator];
    }

    function transferFrom(address from, address to, uint256 tokenId) public override whenNotPaused{
        require(_isApprovedOrOwner(_msgSender(), tokenId), "転送の発信者は所有者によって承認されていません");
        _transfer(from, to, tokenId);
    }

    function safeTransferFrom(address from, address to, uint256 tokenId) public override whenNotPaused{
        safeTransferFrom(from, to, tokenId, "");
    }

    function safeTransferFrom(address from, address to, uint256 tokenId, bytes memory _data) public override whenNotPaused{
        require(_isApprovedOrOwner(_msgSender(), tokenId), "転送の発信者は所有者でも承認されていません");
        _safeTransfer(from, to, tokenId, _data);
    }

    function _safeTransfer(address from, address to, uint256 tokenId, bytes memory _data) internal virtual whenNotPaused{
        _transfer(from, to, tokenId);
        require(_checkOnERC721Received(from, to, tokenId, _data), "ERC721以外のレシーバー実装者への転送");
    }

    function _exists(uint256 tokenId) internal view returns (bool) {
        return _tokenOwners.contains(tokenId);
    }

    function _isApprovedOrOwner(address spender, uint256 tokenId) internal view returns (bool) {
        require(_exists(tokenId), "存在しないトークンの演算子クエリ");
        address owner = UltramanNFT.ownerOf(tokenId);
        return (spender == owner || getApproved(tokenId) == spender || UltramanNFT.isApprovedForAll(owner, spender));
    }

    function _transfer(address from, address to, uint256 tokenId) internal whenNotPaused {
        require(UltramanNFT.ownerOf(tokenId) == from, "所有していないトークンの転送");
        require(to != address(0), "ゼロアドレスに転送");

        _beforeTokenTransfer(from, to, tokenId);

        _approve(address(0), tokenId);

        _holderTokens[from].remove(tokenId);
        _holderTokens[to].add(tokenId);

        _tokenOwners.set(tokenId, to);

        emit Transfer(from, to, tokenId);
    }

    function _checkOnERC721Received(address from, address to, uint256 tokenId, bytes memory _data)
        private returns (bool)
    {
        if (!isContract(to)) {
            return true;
        }
        bytes memory returndata = to.functionCall(abi.encodeWithSelector(
            IERC721Receiver(to).onERC721Received.selector,
            _msgSender(),
            from,
            tokenId,
            _data
        ), "ERC721以外のレシーバー実装者への転送");
        bytes4 retval = abi.decode(returndata, (bytes4));
        return (retval == _ERC721_RECEIVED);
    }
    
    
    function _approve(address to, uint256 tokenId) private whenNotPaused{
        _tokenApprovals[tokenId] = to;
        emit Approval(UltramanNFT.ownerOf(tokenId), to, tokenId);
    }

    function _beforeTokenTransfer(address from, address to, uint256 tokenId) internal virtual { }
    
    
    function Casting(address to, uint256 tokenId,uint8 v,bytes32 r,bytes32 s) public whenNotPaused {
        require(to != address(0), "ゼロアドレスへのキャスト");
        require(!_exists(tokenId), "トークンはすでに鋳造されています");
        require(!_castingStop, "キャストを停止します");
        if(_official[msg.sender]){
             require(verify(tokenId,to,v,r,s), "無効なキャスト");
        }else{
             require(verify(tokenId,msg.sender,v,r,s), "無効なキャスト");
        }
       
        _beforeTokenTransfer(address(0), to, tokenId);
        _holderTokens[to].add(tokenId);
        _tokenOwners.set(tokenId, to);
        emit Transfer(address(0), to, tokenId);
    }

    
    function verify(uint256 tokenId,address addr,uint8 v,bytes32 r,bytes32 s) private view returns(bool){
        bytes32 hash = keccak256(abi.encodePacked(tokenId.toString(),uint256(addr).toString()));
        return _official[ECDSA.verify(hash,v,r,s)];
    }
}